{% extends "base.html" %}

{% block title %}Game - Sky Geoguesser{% endblock %}

{% block nav_content %}
<div class="flex items-center space-x-4">
    <span class="text-white bg-white/10 px-3 py-1 rounded-full">
        Mode: {{ mode.title() }}
    </span>
    <span class="text-white bg-white/10 px-3 py-1 rounded-full capitalize">
        {{ difficulty }}
    </span>
    <span id="score-display" class="text-white bg-yellow-600 px-3 py-1 rounded-full">
        Score: {{ session.score or 0 }}
    </span>
    <a href="{{ url_for('menu') }}" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg transition-colors">
        Menu
    </a>
</div>
{% endblock %}

{% block content %}
<div class="flex h-screen">
    <!-- Sidebar de navigation -->
    <div id="sidebar" class="w-80 bg-black/30 backdrop-blur-sm border-r border-white/10 overflow-y-auto">
        <div class="p-6 border-b border-white/10">
            <h2 class="text-2xl font-bold text-white mb-2">Localisation</h2>
            <p class="text-blue-200 text-sm">Select the location where the image was taken</p>
        </div>
        
        <div class="p-4">
            <div id="location-tree">
                {% for realm, areas in locations.items() %}
                <div class="mb-2">
                    <button
                        id="button-{{ realm }}"
                        class="realm-btn w-full flex items-center justify-between p-3 rounded-lg transition-colors bg-white/5 hover:bg-white/10 text-gray-200"
                        data-realm="{{ realm }}"
                    >
                        <span class="font-semibold">{{ realm }}</span>
                        <i data-lucide="chevron-right" class="w-4 h-4 transform transition-transform"></i>
                    </button>
                    
                    <!-- Areas sous ce realm -->
                    <div id="selection-{{ realm }}" class="realm-areas ml-4 mt-2 space-y-1 hidden">
                        {% for area, locations_list in areas.items() %}
                        <div>
                            <button
                                id="button-{{ realm }}-{{ area }}"
                                class="area-btn w-full flex items-center justify-between p-2 rounded transition-colors text-left bg-white/5 hover:bg-white/10 text-gray-300"
                                data-realm="{{ realm }}"
                                data-area="{{ area }}"
                            >
                                <span class="text-sm">{{ area }}</span>
                                {% if locations_list %}
                                <i data-lucide="chevron-right" class="w-3 h-3 transform transition-transform"></i>
                                {% endif %}
                            </button>
                            
                            <!-- Locations sous cette area (plus simple !) -->
                            {% if locations_list %}
                            <div id="selection-{{ realm }}-{{ area }}" class="area-locations ml-4 mt-1 space-y-1 hidden">
                                {% for location in locations_list %}
                                <button 
                                    id="button-{{ realm }}-{{ area }}-{{ location }}"
                                    class="location-btn w-full p-2 rounded transition-colors text-left text-xs bg-white/5 hover:bg-white/10 text-gray-400"
                                    data-realm="{{ realm }}"
                                    data-area="{{ area }}"
                                    data-location="{{ location }}"
                                >
                                    {{ location }}
                                </button>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Zone de jeu principale -->
    <div class="flex-1 flex flex-col">
        <div class="flex-1 flex flex-col items-center justify-center p-8">
            <!-- Zone d'affichage de l'image -->
            <div id="image-container" class="bg-white/10 backdrop-blur-sm rounded-2xl p-6 border border-white/20">
                <div id="loading-spinner" class="text-center text-white">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
                    <p>Image is loading...</p>
                </div>
                
                <div id="image-display" class="hidden" style="text-align: center;">
                    <div style="display: flex; justify-content: center; margin-top: 20px;">
                        <img id="game-image" class="w-full max-w-2xl h-auto rounded-xl shadow-2xl mb-6" alt="Image to guess">
                    </div>
                    
                    <div class="text-center">
                        <div class="mb-4 text-white">
                            <p id="current-selection-title" class="text-lg">Current selection:</p>
                            <p id="current-selection" class="text-blue-200">
                                Nothing selected
                            </p>
                        </div>
                        <div class="flex flex-row" style="gap: 20px; max-height: 200px; justify-content: center; text-align:center; margin: 0 auto; overflow: hidden;">
                            <img id="select-realm-image" class="mb-4 rounded-xl shadow-2xl mb-6 hidden" style="max-height: 200px; width: auto; height: 100%; object-fit:contain;">
                            <img id="select-area-image" class="mb-4 rounded-xl shadow-2xl mb-6 hidden" style="max-height: 200px; width: auto; height: 100%; object-fit:contain;">
                            <img id="select-location-image" class="mb-4 rounded-xl shadow-2xl mb-6 hidden" style="max-height: 200px; width: auto; height: 100%; object-fit:contain;">
                        </div>
                        <button 
                            id="submit-answer"
                            disabled
                            class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 disabled:from-gray-500 disabled:to-gray-600 text-white font-semibold py-3 px-8 rounded-xl transition-all duration-200 flex items-center justify-center gap-2 mx-auto disabled:cursor-not-allowed"
                            style="margin-top: 20px;"
                        >
                            <i data-lucide="play" class="w-5 h-5"></i>
                            Confirm my answer
                        </button>
                        <div id="picture-continue" class="hidden">
                            {% if mode == 'hunt' %}
                            <button onclick="window.location.href='{{ url_for('game', mode='hunt') }}'" class="btn-nextimage flex-1 bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg transition-colors">
                                Next image
                            </button>
                            {% else %}
                            <button onclick="window.location.href='{{ url_for('menu') }}'" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors">
                                Menu
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de résultat -->
<div id="result-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 max-w-md w-full mx-4 border border-white/20">
        <div id="result-content" class="text-container text-center text-white">
            <!-- Contenu dynamique du résultat -->
        </div>
        
        <div class="flex gap-4 mt-6">
            {% if mode == 'hunt' %}
            <button id="next-image" onclick="window.location.href='{{ url_for('game', mode='hunt') }}'" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg transition-colors">
                Next image
            </button>
            {% endif %}
            <button id="close-result" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors">
                Continue
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script type="module">
    // Initialiser les icônes Lucide
    lucide.createIcons();

    // Variables de jeu
    const gameMode = '{{ mode }}';
    const difficulty = '{{ difficulty }}';
    let currentSelection = {
        realm: '',
        area: '', 
        location: ''
    };


    // selecting/deselecting realms/areas/locations in the sidebar

    function select(place){ //place is realm or realm-area or realm-area-location
        if (place == "") return;
        //show area select
        const area_select = document.getElementById("selection-"+place);
        if (area_select)
            area_select.classList.remove("hidden");
        //button selected
        const button = document.getElementById("button-"+place);
        if (button){
            button.classList.replace("bg-white/5", "bg-white/30");
            button.classList.replace("hover:bg-white/10", "hover:bg-white/50");
            if (button.children.length > 1)
                button.children[1].setAttribute("style", "transform: rotate(90deg);")
        }
    }
    function unselect(place){
        if (place == "") return;
        //hide area select
        const area_select = document.getElementById("selection-"+place);
        if (area_select)
            area_select.classList.add("hidden");
        //button unselected
        const button = document.getElementById("button-"+place);
        if (button){
            button.classList.replace("bg-white/30", "bg-white/5");
            button.classList.replace("hover:bg-white/50", "hover:bg-white/10");
//            button.querySelector("i").setAttribute("data-lucide", "chevron-right")
//            button.children[1].setAttribute("data-lucide", "chevron-right")
            if (button.children.length > 1)
                button.children[1].removeAttribute("style")
        }
    }

    //changing submission button
    function set_valid_selection(){
        document.getElementById("current-selection").innerText = currentSelection.realm+" > "+
            currentSelection.area+" > "+currentSelection.location;
        document.getElementById("submit-answer").removeAttribute("disabled");
    }
    function set_invalid_selection(){
        document.getElementById("current-selection").innerText = "Nothing selected";
        document.getElementById("submit-answer").setAttribute("disabled", true);
    }

    function load_selected_realm_image(realm_name){
        if (realm_name == "") return document.getElementById("select-realm-image").classList.add("hidden");
        let image_url="/api/preview-image?type=realm&realm="+realm_name;
//        let image_url="/api/daily-image";
        loadImageFromJson(image_url, "#select-realm-image", "url");
        return document.getElementById("select-realm-image").classList.remove("hidden");
    }
    function load_selected_area_image(realm_name, area_name){
        if (area_name == "") return document.getElementById("select-area-image").classList.add("hidden");
        let image_url="/api/preview-image?type=area&realm="+realm_name+"&area="+area_name;
//        let image_url="/api/daily-image";
        loadImageFromJson(image_url, "#select-area-image", "url");
        return document.getElementById("select-area-image").classList.remove("hidden");
    }
    function load_selected_location_image(realm_name, area_name, location_name){
        if (location_name == "") return document.getElementById("select-location-image").classList.add("hidden");
        let image_url="/api/preview-image?type=location&realm="+realm_name+"&area="+area_name+"&location="+location_name;
//        let image_url="/api/daily-image";
        loadImageFromJson(image_url, "#select-location-image", "url");
        return document.getElementById("select-location-image").classList.remove("hidden");
    }

    //Button handlers for sidebar
    {% for realm, areas in locations.items() %}
        document.getElementById("button-{{ realm }}").addEventListener("click", () => {
            let selected = "{{ realm }}";
            if (selected == currentSelection.realm) selected = "";
            unselect(currentSelection.realm);
            unselect(currentSelection.realm+"-"+currentSelection.area);
            unselect(currentSelection.realm+"-"+currentSelection.area+"-"+currentSelection.location);
            load_selected_area_image(currentSelection.realm, "");
            load_selected_location_image(currentSelection.realm, currentSelection.area, "");
            currentSelection.realm = selected;
            currentSelection.area = "";
            currentSelection.location = "";
            select(selected);
            set_invalid_selection();
            document.getElementById("current-selection").innerText = currentSelection.realm+" > ... > ...";
            load_selected_realm_image(currentSelection.realm)
        });

        {% for area, locations in areas.items() %}
            document.getElementById("button-{{ realm }}-{{ area }}").addEventListener("click", () => {
                let selected = "{{ area }}";
                if (selected == currentSelection.area) selected = "";
                unselect(currentSelection.realm+"-"+currentSelection.area);
                unselect(currentSelection.realm+"-"+currentSelection.area+"-"+currentSelection.location);
                load_selected_location_image(currentSelection.realm, currentSelection.area, "");
                currentSelection.area = selected;
                currentSelection.location = "";
                select(currentSelection.realm+"-"+selected);
                set_invalid_selection();
                document.getElementById("current-selection").innerText = currentSelection.realm+" > "+
                    currentSelection.area+" > ...";
                load_selected_area_image(currentSelection.realm, currentSelection.area);
            });

            {% for location in locations %}
                document.getElementById("button-{{ realm }}-{{ area }}-{{ location }}").addEventListener("click", () => {
                    let selected = "{{ location }}";
                    if (selected == currentSelection.location) selected = "";
                    unselect(currentSelection.realm+"-"+currentSelection.area+"-"+currentSelection.location);
                    currentSelection.location = selected;
                    select(currentSelection.realm+"-"+currentSelection.area+"-"+selected);
                    if (selected != "")
                        set_valid_selection();
                    else
                        set_invalid_selection();
                    load_selected_location_image(currentSelection.realm, currentSelection.area, currentSelection.location);
                });
            {% endfor %}
        {% endfor %}
    {% endfor %}


    //Submitting the answer and handling response

    async function fetchSubmission(){
        const data = {
            realm: currentSelection.realm,
            area: currentSelection.area,
            location: currentSelection.location
        }

        const flaskResponse = await fetch("/api/check-answer", {
            method: "POST",
            headers: { "Content-Type": "application/json"},
            body: JSON.stringify(data)
        });
        const result = await flaskResponse.json();
        console.log(result);
        if (!flaskResponse.ok)
            document.getElementById("current-selection").innerText = "Error: "+result.error;
        else{
            document.getElementById("submit-answer").classList.add("hidden");
            document.getElementById("sidebar").classList.add("hidden");
            document.getElementById("score-display").innerText = "Score: "+result.total_score;

            //showing the result as txt
            let title = result.points == 0 ? "Wrong" : (result.points < 600 ? "Almost" : "Correct!");
            let place = "The correct location is "+result.correct_answer.realm+" > "+result.correct_answer.area+" > "+
                result.correct_answer.location;
            let correct_guesses = [];
            if (result.is_correct.realm) correct_guesses.push("realm");
            if (result.is_correct.area) correct_guesses.push("area");
            if (result.is_correct.location) correct_guesses.push("location");
            let last = correct_guesses.length == 0 ? null : correct_guesses.pop();
            let guess_result = (last == null) ? "You did not guess the correct area!" : "You guessed the correct "
                +correct_guesses.join(", ")+" and "+last+"!";
            document.getElementById("result-content").innerHTML = "<span class=\"font-semibold text-2xl\">"+title+"</span><p class=\"font-semibold text-lg\">"+place+"</p><p>"+guess_result+"</p>";

            document.getElementById("current-selection-title").innerHTML = "Solution:";
            const green = "#90ee90";
            const red =   "#ffb6c1";
            document.getElementById("current-selection").innerHTML =
                "<span style=\"color: "+(result.is_correct.realm ? green : red)+";\">"+ currentSelection.realm+"</span> > "+
                "<span style=\"color: "+(result.is_correct.area ? green : red)+";\">"+ currentSelection.area+"</span> > "+
                "<span style=\"color: "+(result.is_correct.location ? green : red)+";\">"+ currentSelection.location+"</span>";

            document.getElementById("result-modal").classList.remove("hidden");
            document.getElementById("picture-continue").classList.remove("hidden");
        }//
    }

    // Submission button
    document.getElementById("submit-answer").addEventListener("click", () => {
        fetchSubmission();
    });

    // continue button
    document.getElementById("close-result").addEventListener("click", () => {
        document.getElementById("result-modal").classList.add("hidden");
    });

    // Charger la première image
//    window.addEventListener('DOMContentLoaded', function() {
//        loadNewImage();
//    });
    import {loadImageFromJson} from "{{ url_for('static', filename='js/image-loader.js') }}";

    let image_url = "{{ mode }}"=="daily" ? "/api/daily-image" : "/api/new-image?difficulty={{ difficulty }}";

    window.addEventListener("DOMContentLoaded", () => {
        loadImageFromJson(image_url, "#game-image", "url");
        const loading = document.getElementById("loading-spinner");
        const img = document.getElementById("image-display");
        loading.classList.toggle("hidden");
        img.classList.toggle("hidden");
    });
</script>
{% endblock %}